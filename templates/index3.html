<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Chat with Shomi AI</title>
  <script src="/static/marked.min.js"></script>
  <link rel="stylesheet" href="/static/default.min.css">
  <script src="/static/highlight.min.js"></script>
  <script>hljs.highlightAll();</script>

  <style>
    body, html {
      height: 100%;
      margin: 0;
      font-family: Arial, sans-serif;
      background: #111;
      color: #fff;
      display: flex;
      flex-direction: column;
      align-items: stretch;
    }

.chat-container {
  min-width: 300px;
  width: 100%;
  max-width: 880px;
  flex: 1;
  background: #111;
  overflow-y: auto;
  padding: 20px;
  display: flex;
  flex-direction: column-reverse;
  margin: 0 auto;
  box-sizing: border-box;
}

    .message {
      margin: 10px 0;
      padding: 12px 16px;
      background: #111;
      border-radius: 18px;
      max-width: 100%;
      word-wrap: break-word;
      box-shadow: none;
    }

    .user {
      align-self: flex-end;
      background: #222;
    }

    .ai {
      align-self: flex-start;
      background: #111;
    }

.input-container {
  width: 100%;
  background: #111;
  display: flex;
  justify-content: center;
  padding: 10px;
  box-sizing: border-box;
}

.input-wrapper {
  width: 100%;
  max-width: 800px;
  display: flex;
  flex-direction: column;
  align-items: center;
}

.input-container textarea {
  width: 100%;
  max-width: 800px;
  min-width: 300px;
  padding: 12px;
  border-radius: 18px;
  border: none;
  background: #222;
  color: #fff;
  font-size: 16px;
  height: 60px;
  resize: none;
}

.textarea-wrapper {
  position: relative;
  width: 100%;
  max-width: 800px;
  background: #222;
  border-radius: 18px;
  padding: 12px;
  box-sizing: border-box;
  display: flex;
  flex-direction: column;
}

.textarea-wrapper textarea {
  width: 100%;
  border: none;
  outline: none;
  background: transparent;
  color: #fff;
  font-size: 16px;
  resize: none;
  min-height: 50px;
  /* å»æ‰ max-height:300px */
  /* å»æ‰ overflow-y:auto */
  box-sizing: border-box;
}

.button-wrapper {
  display: flex;
  justify-content: space-between;
  margin-top: 3px; /* æŒ‰é’®å’Œæ–‡æœ¬ä¹‹é—´ç•™ç‚¹ç©ºéš™ */
}

#sendButton, #uploadButton {
  width: 36px;
  height: 36px;
  border-radius: 50%;
  border: none;
  font-size: 18px;
  cursor: pointer;
}

#sendButton {
  background-color: #ffffff;
  color: black;
}

#sendButton:hover:enabled {
  background-color: #8b3a0e;
}

#uploadButton {
  background-color: #111;
  color: white;
}

#uploadButton:hover {
  background-color: #0056b3;
}

.button-left-group {
  display: flex;
  gap: 8px;
  align-items: center;
}

.circleButton {
  width: 36px;
  height: 36px;
  border-radius: 50%;
  border: 1px solid #555;
  background-color: #222;
  color: white;
  font-size: 18px;
  cursor: pointer;
}

.pillButton {
  height: 36px;
  padding: 0 12px;
  border-radius: 18px;
  border: 1px solid #555;
  background-color: #222;
  color: white;
  font-size: 16px;
  display: flex;
  align-items: center;
  gap: 6px;
  cursor: pointer;
  white-space: nowrap;
}

.circleButton:hover, .pillButton:hover {
  background-color: #333;
}

    .loader {
      border: 4px solid #f3f3f3;
      border-top: 4px solid #EB4F27;
      border-radius: 50%;
      width: 15px;
      height: 15px;
      animation: spin 1s linear infinite;
      margin-left: 10px;
	  display: inline-block;
	  transform-origin: center center;
    }

	@keyframes flashing {
	  0% { background-color: #222; }
	  50% { background-color: #333; }
	  100% { background-color: #222; }
	}

	.code-summary.flashing {
	  animation: flashing 1s infinite;
	}

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    ::-webkit-scrollbar {
      width: 8px;
    }

    ::-webkit-scrollbar-track {
      background: #111;
    }

    ::-webkit-scrollbar-thumb {
      background: #888;
      border-radius: 8px;
    }
	
details pre code {
  background-color: #222 !important;
  display: block;
  padding: 10px;
  border-radius: 8px;
  color: #fff !important;
  font-family: Consolas, Monaco, 'Courier New', monospace;
}

  </style>
</head>
<body>
<!-- åªåŒ…å«èŠå¤©è®°å½•çš„åŒºåŸŸ -->
<div class="chat-container" id="chat-container">
  <!-- Chat messages will be here -->
</div>

<!-- å§‹ç»ˆå›ºå®šåœ¨åº•éƒ¨çš„è¾“å…¥åŒºåŸŸ -->
<div class="input-container">
  <div class="input-wrapper">
    <div class="textarea-wrapper">
      <textarea id="input" placeholder="Ask me anything..." rows="1"></textarea>
      <div class="button-wrapper">
        <div class="button-left-group">
		  <button id="uploadButton" title="Upload File" onclick="document.getElementById('fileInput').click()">ğŸ“</button>
		  <button class="pillButton" title="Search">
			ğŸŒ Search
		  </button>

		  <button class="pillButton" title="Deep Research">
			ğŸš€ Deep research
		  </button>

		  <button class="pillButton" title="Create Image">
			ğŸ¨ Create image
		  </button>

		  <button class="circleButton" title="More">
			â‹¯
		  </button>
		</div>
        <button id="sendButton" onclick="sendMessage()">â¤</button>
      </div>
    </div>
    <input type="file" id="fileInput" multiple style="display:none;" onchange="handleFiles(this.files)">
  </div>
</div>

<script>

let uploadedFileIds = []; // ğŸ”¥ ä¿å­˜file_idï¼Œä¸æ˜¯ä¿å­˜fileå¯¹è±¡äº†ï¼
let isRunning = false;
let readerController = null;

// ç»‘å®šæ‹–æ‹½äº‹ä»¶
const textareaWrapper = document.querySelector('.textarea-wrapper');

textareaWrapper.addEventListener('dragover', function(event) {
  event.preventDefault(); // é˜»æ­¢æµè§ˆå™¨é»˜è®¤æ‹–æ‹½å¤„ç†
  this.style.backgroundColor = '#333'; // æ‹–æ‹½æ—¶åŠ æ·±èƒŒæ™¯è‰²æç¤º
});

textareaWrapper.addEventListener('dragleave', function(event) {
  event.preventDefault();
  this.style.backgroundColor = '#222'; // æ‹–å‡ºæ—¶æ¢å¤èƒŒæ™¯è‰²
});

textareaWrapper.addEventListener('drop', function(event) {
  event.preventDefault();
  this.style.backgroundColor = '#222'; // æ¢å¤èƒŒæ™¯è‰²
  const files = event.dataTransfer.files;
  if (files.length > 0) {
    handleFiles(files); // è°ƒç”¨å·²æœ‰é€»è¾‘
  }
});

function removeFile(index, button) {
  uploadedFileIds.splice(index, 1); // ğŸ”¥ åˆ é™¤å¯¹åº”ä½ç½®çš„file_id
  const messageDiv = button.parentElement;
  messageDiv.remove(); // ğŸ”¥ ä»ç•Œé¢ä¸Šåˆ é™¤æ–‡ä»¶æ˜¾ç¤º
}

async function uploadFile(file) {
  const formData = new FormData();
  formData.append('file', file);
  const response = await fetch('/upload', { method: 'POST', body: formData });
  const data = await response.json();
  
  if (data.file_id) {
    uploadedFileIds.push(data.file_id);
    console.log("Uploaded file_id:", data.file_id);
  } else {
    console.error("File upload failed:", data);
  }
}

async function handleFiles(files) {
  for (const file of files) {
    await uploadFile(file); // åªä¸Šä¼ ä¸€æ¬¡
    // ç»§ç»­å±•ç¤ºæ–‡ä»¶ç•Œé¢
    const chatContainer = document.getElementById('chat-container');
    // ï¼ˆçœç•¥å±•ç¤ºæ–‡ä»¶çš„ä»£ç ï¼‰

    // æ ¹æ®æ–‡ä»¶æ‰©å±•åé€‰æ‹©å¯¹åº”å›¾æ ‡
    const fileType = file.name.split('.').pop().toLowerCase();
    let iconSrc = '/static/file-default.png'; // é»˜è®¤å›¾æ ‡
    if (fileType === 'zip' || fileType === 'rar' || fileType === '7z') {
      iconSrc = '/static/file-zip.png';
    } else if (fileType === 'xlsx' || fileType === 'xls' || fileType === 'csv') {
      iconSrc = '/static/file-excel.png';
    } else if (fileType === 'pdf') {
      iconSrc = '/static/file-pdf.png';
    } else if (fileType === 'doc' || fileType === 'docx') {
      iconSrc = '/static/file-word.png';
    } else if (fileType === 'png' || fileType === 'jpg' || fileType === 'jpeg') {
      iconSrc = '/static/file-image.png';
    }
    // å…¶ä»–å¯ä»¥ç»§ç»­è¡¥å……åˆ¤æ–­

const fileMessage = document.createElement('div');
fileMessage.className = 'message user';
fileMessage.style.position = 'relative'; // ğŸ”¥ è®©å‰å‰å¯ä»¥ç»å¯¹å®šä½

const index = uploadedFileIds.length - 1; // ğŸ”¥ å½“å‰file_idåœ¨æ•°ç»„é‡Œçš„ä½ç½®

fileMessage.innerHTML = `
  <button onclick="removeFile(${index}, this)" style="position:absolute; top:2px; right:2px; background:none; border:none; color:white; font-size:14px; cursor:pointer;">âŒ</button>
  <div style="display: flex; align-items: center; gap: 8px; padding-top: 8px;">
    <img src="${iconSrc}" alt="file" style="width:24px;height:24px;">
    <span>${file.name}</span>
  </div>
`;

chatContainer.prepend(fileMessage);

    scrollToBottom();
  }
}

const input = document.getElementById('input');

input.addEventListener('input', function() {
  this.style.height = 'auto'; // å…ˆé‡ç½®
  this.style.height = this.scrollHeight + 'px'; // å†æ ¹æ®å†…å®¹è®¾ç½®é«˜åº¦
});

document.getElementById('input').addEventListener('keypress', function(event) {
  if (event.key === 'Enter' && !event.shiftKey) {
    event.preventDefault();
    sendMessage();
  }
});

function scrollToBottom() {
  const chatContainer = document.getElementById('chat-container');
  chatContainer.scrollTop = chatContainer.scrollHeight;
}

function sendMessage() {
  const input = document.getElementById('input');
  const chatContainer = document.getElementById('chat-container');
  const sendButton = document.getElementById('sendButton');

if (isRunning) {
  if (readerController) {
    readerController.cancel().catch(err => console.error('Error cancelling reader:', err));
    readerController = null;
  }
  
  fetch('/stop', { method: 'POST' })
	  .then(response => response.json())
	  .then(data => {
		console.log('Stop response:', data);
		if (data.status === 'cancelled') {
		  sendButton.innerHTML = 'â¤';
		  isRunning = false;

		  // ğŸ”¥ğŸ”¥ğŸ”¥ è¿™é‡ŒåŠ 
		  const aiContents = document.querySelectorAll('.ai-content');
		  aiContents.forEach(content => {
			const flashingSummary = content.querySelector('summary.flashing');
			if (flashingSummary) {
			  flashingSummary.classList.remove('flashing');
			}
		  });
		}
	  })
	.catch(error => {
	  console.error('Error stopping:', error);
	  // â—å¼‚å¸¸ä¹Ÿä¸æ”¹å˜æŒ‰é’®
	});

  return;
}

  if (!input.value.trim()) return;
  
  sendButton.disabled = true; // ç‚¹å‡»å‘é€ï¼Œç«‹åˆ»ç¦ç”¨ï¼Œé˜²æ­¢è¿ç‚¹

  const now = new Date();
  const hours = now.getHours().toString().padStart(2, '0');
  const minutes = now.getMinutes().toString().padStart(2, '0');
  const timestamp = `YOU - ${hours}:${minutes}PM`;

  const userMessage = document.createElement('div');
  userMessage.className = 'message user';
  userMessage.innerHTML = `<strong style="font-size: 16px; color: #888;">${timestamp}</strong><br>${input.value}`;
  chatContainer.prepend(userMessage);

  const aiMessage = document.createElement('div');
  aiMessage.className = 'message ai';
  aiMessage.innerHTML = `
  <div style="display: flex; align-items: center; gap: 8px;">
    <img src="/static/galaxa ai.png" alt="AI" style="width:24px;height:24px;border-radius:50%;">
    <strong style="font-size: 16px; color: #888;">${hours}:${minutes}PM</strong>
    <span id="loader" class="loader" style="margin-left: 4px;"></span>
  </div>
  <div class="ai-content">
    <div id="ai-text"></div>
  </div>`;

  chatContainer.prepend(aiMessage);

  document.getElementById('loader').style.display = 'inline-block';

  const aiContent = aiMessage.querySelector('#ai-text');

const formData = new FormData();
formData.append('question', input.value);
for (const file_id of uploadedFileIds) {
  formData.append('file_ids', file_id);  // âš¡æ”¹ä¸ºå‘ file_id
}

  fetch("/ask", {
    method: "POST",
    body: formData
  }).then(response => {
    const reader = response.body.getReader();
	readerController = reader; // ğŸ”¥ä¿å­˜å½“å‰æ­£åœ¨è¯»çš„æµ
	 
    function read() {
      reader.read().then(({ done, value }) => {
        if (done) {
          aiMessage.querySelector('.loader').style.display = 'none';
          sendButton.disabled = false;
          sendButton.innerHTML = 'â¤'; // æ¢å¤æˆå‘é€å›¾æ ‡
          isRunning = false;
          scrollToBottom();
          return;
        }
        const line = new TextDecoder().decode(value, { stream: true }).trim();
        if (line) {
          try {
            const event = JSON.parse(line);

            if (!aiContent.dataset.mode) {
              aiContent.dataset.mode = 'none';
              aiContent.accumulatedText = '';
            }

            if (event.type === 'text') {
              if (aiContent.dataset.mode !== 'text') {
                aiContent.dataset.mode = 'text';
              }
              if (!aiContent.currentBlock) {
                const textBlock = document.createElement('div');
                textBlock.className = 'text-block';
                aiContent.appendChild(textBlock);
                aiContent.currentBlock = textBlock;
              }
              if (!aiContent.accumulatedText) {
                aiContent.accumulatedText = '';
              }
              aiContent.accumulatedText += event.content;
              aiContent.currentBlock.innerHTML = marked.parse(aiContent.accumulatedText);
            } 
            else if (event.type === 'code_start') {
              const codeBlock = document.createElement('details');
              codeBlock.style.backgroundColor = '#222';
              codeBlock.style.borderRadius = '8px';
              codeBlock.style.margin = '8px 0';
              codeBlock.style.padding = '5px';
              codeBlock.style.overflow = 'hidden';
              codeBlock.classList.add('code-block');

              const summary = document.createElement('summary');
              summary.textContent = 'Executing Commandâ€¦â€¦';
              summary.style.cursor = 'pointer';
              summary.style.backgroundColor = '#222';
              summary.style.padding = '8px 12px';
              summary.style.borderRadius = '8px';
              summary.style.color = '#ccc';
              summary.classList.add('code-summary', 'flashing');

              const pre = document.createElement('pre');
              pre.style.backgroundColor = '#222';
              pre.style.padding = '10px';
              pre.style.borderRadius = '8px';
              pre.style.overflowX = 'auto';
              pre.style.margin = '0';

              const code = document.createElement('code');
              code.className = 'language-python';
              pre.appendChild(code);

              codeBlock.appendChild(summary);
              codeBlock.appendChild(pre);

              aiContent.appendChild(codeBlock);
              aiContent.currentBlock = code;
              aiContent.currentSummary = summary;
              aiContent.dataset.mode = 'code';
            } 
            else if (event.type === 'code_content') {
              if (aiContent.dataset.mode === 'code') {
                aiContent.currentBlock.textContent += event.content;
              }
            } 
            else if (event.type === 'code_end') {
              if (aiContent.currentSummary) {
                aiContent.currentSummary.classList.remove('flashing');
                aiContent.currentSummary = null;
              }
              if (aiContent.currentBlock) {
                hljs.highlightElement(aiContent.currentBlock);
                aiContent.currentBlock = null;
              }
              aiContent.dataset.mode = 'text';
            }
          } catch (e) {
            console.error('Parse error:', e);
          }
        }
        scrollToBottom();
        read();
      }).catch(error => {
        console.error('Error:', error);
        aiMessage.querySelector('.loader').style.display = 'none';
        sendButton.disabled = false;
        sendButton.innerHTML = 'â¤';
        isRunning = false;
      });
    }
    read();
  });

  sendButton.innerHTML = 'â—¼'; // å¼€å§‹åå˜æˆåœæ­¢
  sendButton.disabled = false; // âœ… è§£é™¤ç¦ç”¨
  isRunning = true;
  input.value = '';
  input.style.height = 'auto';
}

</script>

</body>
</html>
